name: æ„å»ºå’Œå‘å¸ƒ

env:
  PACKAGE_NAME: myraid_box
  ZIP_NAME: myraid_box.zip

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          # è®¾ç½®é›†æˆç›®å½•è·¯å¾„
          INTEGRATION_DIR="custom_components/${{ env.PACKAGE_NAME }}"
          echo "INTEGRATION_DIR=$INTEGRATION_DIR" >> $GITHUB_ENV

      - name: åŒæ­¥æ ‡ç­¾
        run: |
          git fetch --tags --force
          echo "ä»Šæ—¥å·²æœ‰æ ‡ç­¾:"
          git tag -l "v$(date +%Y%m%d)*" | sort -V || true

      - name: è®¡ç®—ç‰ˆæœ¬å·
        id: version_calc
        run: |
          export TZ=Asia/Shanghai
          DATE_PATTERN="$(date +%Y%m%d)"
          TAG_PREFIX="v${DATE_PATTERN}"

          # è·å–å½“å¤©æœ€å¤§åºå·
          MAX_NUM=$(git tag -l "${TAG_PREFIX}*" | grep -oE '[0-9]{2}$' | sort -nr | head -1)
          MAX_NUM=${MAX_NUM:-0}
          NEXT_NUM=$((10#$MAX_NUM + 1))
          NEW_VERSION="${TAG_PREFIX}$(printf '%02d' $NEXT_NUM)"

          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_prefix=$TAG_PREFIX" >> $GITHUB_OUTPUT

      - name: æ¸…ç†å·²æœ‰å‘å¸ƒ
        if: always()
        continue-on-error: true
        run: |
            # æ£€æŸ¥å‘å¸ƒæ˜¯å¦å­˜åœ¨
            if gh release view "${{ steps.version_calc.outputs.version }}" >/dev/null 2>&1; then
              echo "å‘ç°åŒåå‘å¸ƒï¼Œæ­£åœ¨åˆ é™¤..."
              gh release delete "${{ steps.version_calc.outputs.version }}" --cleanup-tag -y
              echo "å·²åˆ é™¤åŒåå‘å¸ƒ"
            else
              echo "æ²¡æœ‰æ‰¾åˆ°åŒåå‘å¸ƒï¼Œè·³è¿‡åˆ é™¤"
            fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ‰“åŒ…é›†æˆ
        run: |
          # æ£€æŸ¥é›†æˆç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$INTEGRATION_DIR" ]; then
            echo "é”™è¯¯: é›†æˆç›®å½• '$INTEGRATION_DIR' ä¸å­˜åœ¨!"
            exit 1
          fi

          # åˆ›å»ºZIPåŒ…
          zip -r "${{ env.ZIP_NAME }}" "$INTEGRATION_DIR" \
            -x "*/__pycache__/*" "*/.git*" "*.pyc" "*.log" "*.tmp"

          # éªŒè¯ZIPæ–‡ä»¶
          if [ ! -f "${{ env.ZIP_NAME }}" ]; then
            echo "é”™è¯¯: ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥!"
            exit 1
          fi

          echo "æ‰“åŒ…å®Œæˆ: ${{ env.ZIP_NAME }}"
          ls -la "${{ env.ZIP_NAME }}"

      - name: åˆ›å»ºå‘å¸ƒ
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ env.ZIP_NAME }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "${{ steps.version_calc.outputs.version }}"
          name: "${{ env.PACKAGE_NAME }} ${{ steps.version_calc.outputs.version }}"
          body: |
            ### ğŸš€ æ›´æ–°å†…å®¹

            - æ–°å¢è·å–istoreosè®¾å¤‡ç‰ˆæœ¬
            - æ·»åŠ åŠ¨æ€æœåŠ¡ç®¡ç†
            
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ä¸‹æ–¹çš„ **${{ env.ZIP_NAME }}** æ–‡ä»¶
            2. é€šè¿‡ HACS è‡ªå®šä¹‰ä»“åº“å®‰è£…
            3. æˆ–æ‰‹åŠ¨è§£å‹åˆ° `custom_components/` ç›®å½•

            ### â„¹ï¸ é›†æˆä¿¡æ¯
            - ç‰ˆæœ¬: ${{ steps.version_calc.outputs.version }}
            - æ„å»ºæ—¥æœŸ: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          makeLatest: true
          skipIfReleaseExists: true

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          if [ -f "${{ env.ZIP_NAME }}" ]; then
            rm -f "${{ env.ZIP_NAME }}"
            echo "å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
          fi

      - name: å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ åŒ…åç§°: ${{ env.PACKAGE_NAME }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬å·: ${{ steps.version_calc.outputs.version }}"
          echo "ğŸ“ æ–‡ä»¶: ${{ env.ZIP_NAME }}"